---
title: "Untitled"
author: "Enzo Moraes Mescall"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(deSolve)
library(tidyverse)
library(plotly)
```



```{r}
predator.pray.model = function(t, State, Pars) {
  with(as.list(c(State, Pars)), {
    dPrey = (b * (1 - Prey/(k - eta * Degradation)) - h_0 * Predator - alpha * Poaching) * Prey + m_0 - m * Degradation
    
    dPredator = ( h_1 * (Prey) - d - beta * RetaliatoryKillings - S * Tourism) * Predator
    
    dTourism = A/Tourism - delta * Degradation
    
    dPoaching = gamma * (r_p * Prey - (Omega + sigma_p * (lambda_0 + lambda * Tourism))) * Poaching
    
    dRetaliatoryKillings = c * Predator - B * Tourism
    
    dDegradation = G - E_r - I_0 + (P_t - I_t) * Tourism
  
    equations = c(dPrey, dPredator, dTourism,
                dPoaching, dRetaliatoryKillings, dDegradation)
    
    return(list(equations))
  })
}

# Time vectors, parameters, and initial condition
t = seq(0, 50, 0.02)

Pars = c(gamma = 1,     # speed of poaching adjustment
         r_p =  0.04,   # revenue per poach
         Omega =  0.6,  # opportunity cost
         sigma_p = 0.01,# risk of poaching
         lambda_0 = 30, # base law enforcement level
         lambda = 10,   # law enforcement per investment
         c = 0.375,     # culling rate per predator
         B = 0.5,       # boma construction per unit invested
         E_r = 0.5,     # baseline recovery rate
         I_0 = 0.5,     # baseline government investment
         P_t = 0.3,     # average pollution per tourist
         I_t = 0.1,     # investment into ecology per tourism income
         G = 0.4,       # impact of global warming on degradation
         b = 0.3,       # birth rate of prey
         k = 120,       # carrying capacity of prey
         eta = 1,       # sensitivity of degradation on carrying cap
         h_0 = 0.05,    # effect of hunting on prey population
         alpha = 0.01,  # poaching effectiveness
         m_0 = 1.5,     # baseline migration inwards
         m = 0.5,       # effect of degradation on outwards migration
         h_1 = 0.05,    # conversion of prey biomass into predator biomass
         d = 0.17,      # death rate of predators
         beta = 0.1,    # effectiveness of retaliatory killings
         S = 0.01,      # sensitivity of predators to tourist distractions
         delta = 0.01,  # effect of degradation on tourism
         A = 0.01)      # tourism destination attractiveness saturation

X_0 = c(Prey = 300,
        Predator = 4,
        Tourism = 3,
        Poaching = 2.30792,
        RetaliatoryKillings = 13,
        Degradation = 3)
```

```{r}
# Calculating where the equilibrium is gonna be

with(as.list(Pars), {
  Tourism = (E_r + I_0 - G)/(P_t - I_t)
  
  Predator = Tourism * B/c
  
  Degradation = Tourism * A/delta
  
  Prey = (Omega + sigma_p * (lambda_0 + lambda * Tourism))/r_p
  
  RetaliatoryKillings =  (h_1 * Prey - d - S * Tourism)/beta
  
  Poaching = ((b * (1 - Prey / (k - eta * Degradation)) - h_0 * Predator) * Prey + m_0 - m * Degradation)/(alpha * Prey)
  
  c(Prey = Prey, Pred = Predator, T = Tourism, Poach = Poaching, RK = RetaliatoryKillings, D = Degradation)
})
```


```{r}
ode(
  func = predator.pray.model,
  y = X_0,
  times = t,
  parms = Pars
) %>% as.data.frame() -> out
```

```{r}
out %>%
gather(variable, value, -time) %>%
ggplot(aes(x = time, y = value, color = variable)) +
    geom_line() +
  labs(x = 'time',y = 'Counts')
```

```{r}
a_vals = c(0.3, 0.7, 1)
b_vals = c(0.05, 0.1, 0.3)

expand.grid(a = a_vals, b = b_vals) %>%
  group_by(a, b) %>%
  do({ode(func = predator.pray.model,
          y = X_0,
          times = t,
          parms = c(a=.$a, b=.$b, c = 0.4, d = 0.05)) %>%
        as.data.frame()}) %>%
  ggplot(aes(x = time)) +
    geom_line(aes(y = x), color = "red") +
    geom_line(aes(y = y), color = "blue") +
    facet_grid(a ~ b, scales='free_y', labeller=label_both) +
  labs(y = "Population")
```


```{r}
out %>%
  ggplot(aes(x = Predator,y = Prey)) +
  geom_path() +
  geom_point(aes(x = X_0[2], y = X_0[1]), colour="red") +
  labs(title = "Predator x Pray Dynamics in the System of ODEs",
       subtitle = "Red point indicates initial condition",
       x = "Predator Population (Thousands)",
       y = "Prey Population (Thousands)")
```

```{r}
out %>%
  plot_ly(x = ~Predator, y = ~Prey, z = ~Poaching) %>%
    add_paths()
```






 